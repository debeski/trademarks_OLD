{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <!-- Include PDF.js Library -->
    <script type="module" src="{% static 'pdfjs/build/pdf.mjs' %}"></script>
    <script type="module">
        import * as pdfjsLib from "{% static 'pdfjs/build/pdf.mjs' %}";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdfjs/build/pdf.worker.mjs' %}";

        document.addEventListener("DOMContentLoaded", async function () {
            {% if objection.pdf_file %}
                const url = "{{ objection.pdf_file.url }}";
                const canvas = document.getElementById("pdf-canvas");
                const ctx = canvas.getContext("2d");

                try {
                    const pdf = await pdfjsLib.getDocument(url).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.8 });

                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const renderContext = { canvasContext: ctx, viewport: viewport };
                    await page.render(renderContext);
                } catch (error) {
                    console.error("Error loading PDF:", error);
                }
            {% endif %}
        });
    </script>
{% endblock %}


{% block content %}

    <!-- Dynamic Card Container for Publication Details -->
    <div id="publication-objection" class="container-fluid mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                    <h5 class="card-title mt-1">تفـــاصيل الاشهـــار المتنازع عليه</h5>
            </div>
            <div class="card-body row">
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>رقم الاشهار:</strong> {{ objection.pub.number }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>رقم القرار:</strong> {{ objection.pub.decree.number }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>مقدم الطلب:</strong> {{ objection.pub.applicant }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>مالك العلامة:</strong> {{ objection.pub.owner }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>الدولة:</strong> {{ objection.pub.get_country_display }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>العنوان:</strong> {{ objection.pub.address }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>تاريخ الطلب:</strong> {{ objection.pub.created_at|date:"Y-m-d" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>التصنيف:</strong> {{ objection.pub.category }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>العلامة التجارية (AR):</strong> {{ objection.pub.ar_brand }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>العلامة التجارية (EN):</strong> {{ objection.pub.en_brand }}</p>
                        </div>
                    </div>
                    <p><strong>تاريخ الاشهار:</strong> {{ objection.pub.created_at }}</p>
                </div>
            {% if objection.pub.img_file %}
                <div class="col-md-4 d-flex align-items-center justify-content-center">
                    <img src="{{ objection.pub.img_file.url }}" class="img-fluid mt-2" alt="Brand Image" style="max-height: 220px;">
                </div>
            {% else %}
                <p class="text-muted">لا يوجد صورة لهذه الوثيقة</p>
            {% endif %}
            </div>
        </div>
        <hr>
    </div>


    <!-- Row for Objection Details and PDF -->
    <div class="row">
        <!-- Left Column: Objection Details -->
        <div class="col-md-7">
            <div class="card border-light shadow-sm">
                <div class="card-header text-center pe-5">
                    <h5 class="card-title mb-0">تفاصيل الاعتراض</h5>
                </div>
                <div class="card-body">
                    <p><strong>رقم الاعتراض: </strong> {{ objection.number }}</p>
                    <p><strong>اسم مقدم الاعتراض: </strong> {{ objection.name }}</p>
                    <p><strong>المهنة: </strong> {{ objection.job }}</p>
                    <p><strong>الجنسية: </strong> {{ objection.get_nationality_display }}</p>
                    <p><strong>محل الاقامة: </strong> {{ objection.address }}</p>
                    <p><strong>رقم الهاتف: </strong> {{ objection.phone }}</p>

                    <p><strong>اسم الشركة: </strong> {{ objection.com_name }}</p>
                    <p><strong>غرض الشركة: </strong> {{ objection.get_com_job_display }}</p>
                    <p><strong>عنوان الشركة: </strong> {{ objection.com_address }}</p>
                    <p><strong>عنوان المقر الرئيسي: </strong> {{ objection.com_og_address }}</p>
                    <p><strong>عنوان البريد لاستلام المكاتبات: </strong> {{ objection.com_mail_address }}</p>

                    <p><strong>حالة الاعتراض: </strong> {{ objection.get_status_display }}</p>

                    <p><strong>ملاحظات: </strong> {{ objection.notes|default:"-" }}</p>
                </div>
            </div>
        </div>

        <!-- Right Column: PDF -->
        <div class="col">
            <div class="card border-light shadow-sm">
                <div class="card-header text-center pe-5">
                    <h5 class="card-title mb-0">معاينة الملف المرفق بالاعتراض</h5>
                </div>
                <div class="card-body">
                        {% if objection.pdf_file %}
                        <canvas id="pdf-canvas" class="img-fluid"></canvas>
                    {% else %}
                        <p class="text-muted">لا يوجد ملف PDF لهذا الاعتراض</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
